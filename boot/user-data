#cloud-config
hostname: PrintALaPi
manage_etc_hosts: true
timezone: Europe/Berlin
locale: de_DE.UTF-8

keyboard:
  layout: de
  variant: nodeadkeys

ssh_pwauth: true

users:
  - name: printalapi
    gecos: 'Masteruser Cups Printserver'
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    lock_passwd: false
    ssh_authorized_keys:
      - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINu7NSzoROSCDrt/7C2zIW7k2YTo4H5nbQPI2PmsOFVo derek@t495"
      - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDJ3Bhb61iZo38+cghPjlIkusOLqVUIwbURCESyLL6Cdb7drN8+0l+5VlhuKH5NeeWQrgM8RwI02HWfCwOqGBuO86cG7uUl+Fi7PENtpKy8KGBOeEutFrQcgTRnjeQiZB2on1X+KItgO/sla46L0qH9aKzoB6NzuuVWnopqvqs+HK/RshLmXCBmGpPF2UqUJIO69IhcbvmwnZPgfvOGSFpY9/9nV/+ZaABiEerj1i9bjJvVoLfZTQ8oOH5IQdDE/qZorWNIzDaBLlkn0929273FE48Q/b8RIwdx6fV137Ysbq67SJtvyP4eCRjZk8ux/BqnktSGD/6uKC8KgtuFAfLd root@knx"

chpasswd:
  list: |
    printalapi:printalapi
  expire: true

bootcmd:
  - [systemctl, stop, systemd-timesyncd]
  - [bash, -c, 'date -s "$(curl -s -m 10 --head http://google.com | grep -i "^Date:" | cut -d" " -f2-)" || date -s "2025-01-01 12:00:00"']
  - [systemctl, start, systemd-timesyncd]
  - [timedatectl, set-ntp, "true"]
  - [sleep, "10"]

package_update: true
package_upgrade: true

packages:
  - cups
  - avahi-daemon
  - libnss-mdns
  - printer-driver-all
  - cups-bsd
  - cups-client
  - zram-tools
  - sysstat
  - lsof
  - python3
  - python3-pip
  - python3-flask
  - git

write_files:
  - path: /etc/default/zramswap
    content: |
      ALGO=lz4
      PERCENT=25
      PRIORITY=100
    permissions: '0644'
    owner: root:root
  - path: /etc/modprobe.d/zram.conf
    content: |
      options zram num_devices=2
    permissions: '0644'

runcmd:
  - [systemctl, enable, ssh]
  - [systemctl, start, ssh]
  - [chage, -d, "0", printalapi]
  - [wget, https://raw.githubusercontent.com/dezihh/PrintALaPi/master/scripts/setup/start_prepare.sh, -O, /root/prepare.sh]
  - [chmod, +x, /root/prepare.sh]

power_state:
  mode: reboot
  message: "Cloud-init configuration done"
  timeout: 30
  condition: true
